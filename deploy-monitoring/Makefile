include vars.mk

OVERLAY ?= docker-desktop

.PHONY: \
	prepare-monitoring-namespace \
	apply-prometheus-rbac \
	wait-for-es \
	setup-es-auth-secret \
	install-monitoring \
	remove-monitoring \
	purge


prepare-monitoring-namespace:
	@echo "Eventually creating Namespace: $(MONITORING_NS)"
	@-kubectl create namespace "$(MONITORING_NS)"
	@-kubectl label namespace "$(MONITORING_NS)" istio-injection=disabled


apply-prometheus-rbac: prepare-monitoring-namespace
	@kubectl apply -f ./bases/prometheus/rbac/


install-monitoring: prepare-monitoring-namespace apply-prometheus-rbac
	@kubectl apply -k ./overlays/$(OVERLAY)
	@make setup-es-auth-secret


wait-for-es:
	@kubectl wait 'pod/jaeger-tracing-backend-es-default-0' \
		--for=condition=Ready --timeout=300s -n "$(MONITORING_NS)"


## `elasticsearch-auth.yml` is the secret that hosts environment variables that will be used
##                          by Jaeger components to reach its backend storage. It is used to store
##                          ElasticSearch cluster authentication parametters.
##                          This Target does not pushes the secret to the ES cluster, see `setup-es-auth-secret`
elasticsearch-auth.yml: ES_USERNAME = elastic
elasticsearch-auth.yml: elasticsearch-auth.yml.tmpl wait-for-es
	@ES_USERNAME_B64="$(shell printf '$(ES_USERNAME)' | base64)" \
	ES_PASSWORD_B64="$(shell kubectl -n "$(MONITORING_NS)" get secret jaeger-tracing-backend-es-elastic-user -o go-template='{{.data.elastic}}')" \
	envsubst < $< > $@
	@printf 'ElasticSearch Cluster auth\nUser: %s\nPassword: %s\n----\n' "$(ES_USERNAME)" "$(shell kubectl -n "$(MONITORING_NS)" get secret jaeger-tracing-backend-es-elastic-user -o go-template='{{.data.elastic | base64decode}}')"


## `setup-es-auth-secret`: Applies the secret generated by `elasticsearch-auth.yml` to the k8s Cluster
setup-es-auth-secret: elasticsearch-auth.yml
	@kubectl apply -n "$(MONITORING_NS)" -f $<


remove-monitoring:
	@-kubectl delete -k ./overlays/$(OVERLAY)
	@-kubectl delete -f ./elasticsearch-auth.yml -n "$(MONITORING_NS)"
	@-rm -rf ./elasticsearch-auth.yml
	@-kubectl delete namespace "$(MONITORING_NS)"

purge: remove-monitoring